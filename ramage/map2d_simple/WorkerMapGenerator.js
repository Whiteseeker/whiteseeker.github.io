function randomIntFromInterval(r,o){return Math.floor(Math.random()*(o-r+1)+r)}function isStable(r,o,a,e,n){for(var t=[],l=a[r+o*n],s=-e;e>=s;s++)for(var u=-e;e>=u;u++)0>r+s||r+s>=n||0>o+u||o+u>=n||l>a[r+s+(o+u)*n]&&(t[t.length]={x:r+s,y:o+u});if(t.length>0){var g=randomIntFromInterval(0,t.length-1);return t[g]}return void 0}function blur(r){console.log("[worker] Start blur");var o=r.gaussian;console.log("[worker] gaussian = "+o);var a=r.width,e=r.height,n=r.img,t=[];if(o>0){for(var l=0;a*e>l;l++)t[l]=0;gaussBlur_4(n,t,a,e,o)}else t=n;for(var s=0,u=5e3,l=0;a*e>l;l++)t[l]<u&&(u=t[l]),t[l]>s&&(s=t[l]);console.log("[worker] maxVal: "+s),console.log("[worker] minVal: "+u),postMessage({type:"Result",data:t,maxVal:s,minVal:u})}function generateMap(r){console.log("[worker] Start generating map");var o=r.nbDrop;console.log("[worker] nbDrop = "+o);var a=r.minPart;console.log("[worker] minPart = "+a);var e=r.maxPart;console.log("[worker] maxPart = "+e);var n=r.maxRetry;console.log("[worker] maxRetry = "+n);var t=r.agitateRange;console.log("[worker] agitateRange = "+t);var l=r.gaussian;console.log("[worker] gaussian = "+l);var s=r.width,u=r.height,g=r.seed;console.log("[worker] seed = "+g),Math.seedrandom(g);for(var v=[],i=0;s*u>i;i++)v[i]=0;for(var f=1,i=0;o>i;i++){postMessage({type:"Update",val:100*(i/o)});for(var m=randomIntFromInterval(1,s-2),d=randomIntFromInterval(1,u-2),c=randomIntFromInterval(a,e),h=0;c>h;h++){for(var b=m,x=d,p=isStable(b,x,v,t,s),M=0;p&&n>M;)M++,b=p.x,x=p.y,p=isStable(p.x,p.y,v,t,s);v[b+x*s]++,f<v[b+x*s]&&(f=v[b+x*s])}}for(var w=f,i=0;s*u>i;i++)v[i]<w&&(w=v[i]);console.log("[worker] maxVal: "+f),console.log("[worker] minVal: "+w),postMessage({type:"Update",val:100}),r.img=v,blur(r)}function boxesForGauss(r,o){var a=Math.sqrt(12*r*r/o+1),e=Math.floor(a);e%2==0&&e--;for(var n=e+2,t=(12*r*r-o*e*e-4*o*e-3*o)/(-4*e-4),l=Math.round(t),s=[],u=0;o>u;u++)s.push(l>u?e:n);return s}function gaussBlur_4(r,o,a,e,n){var t=boxesForGauss(n,3);boxBlur_4(r,o,a,e,(t[0]-1)/2),boxBlur_4(o,r,a,e,(t[1]-1)/2),boxBlur_4(r,o,a,e,(t[2]-1)/2)}function boxBlur_4(r,o,a,e,n){for(var t=0;t<r.length;t++)o[t]=r[t];boxBlurH_4(o,r,a,e,n),boxBlurT_4(r,o,a,e,n)}function boxBlurH_4(r,o,a,e,n){for(var t=1/(n+n+1),l=0;e>l;l++){for(var s=l*a,u=s,g=s+n,v=r[s],i=r[s+a-1],f=(n+1)*v,m=0;n>m;m++)f+=r[s+m];for(var m=0;n>=m;m++)f+=r[g++]-v,o[s++]=Math.round(f*t);for(var m=n+1;a-n>m;m++)f+=r[g++]-r[u++],o[s++]=Math.round(f*t);for(var m=a-n;a>m;m++)f+=i-r[u++],o[s++]=Math.round(f*t)}}function boxBlurT_4(r,o,a,e,n){for(var t=1/(n+n+1),l=0;a>l;l++){for(var s=l,u=s,g=s+n*a,v=r[s],i=r[s+a*(e-1)],f=(n+1)*v,m=0;n>m;m++)f+=r[s+m*a];for(var m=0;n>=m;m++)f+=r[g]-v,o[s]=Math.round(f*t),g+=a,s+=a;for(var m=n+1;e-n>m;m++)f+=r[g]-r[u],o[s]=Math.round(f*t),u+=a,g+=a,s+=a;for(var m=e-n;e>m;m++)f+=i-r[u],o[s]=Math.round(f*t),u+=a,s+=a}}importScripts("//cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.0/seedrandom.min.js"),onmessage=function(r){console.log("Message received from main script"),r.data.nbDrop?generateMap(r.data):blur(r.data)};