---
layout: game
custom_css: ['game/game.css']
---

<canvas class="game-canvas" id="glcanvas" touch-action="none">
  Your browser doesn't appear to support the 
  <code>&lt;canvas&gt;</code> element.
</canvas>

<button id="button_option" class="mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-js-ripple-effect">
  <i class="material-icons">settings</i>
</button>

<div id="money" class="noselect">
  <div id="money_amount">0</div>
  <div id="money_unit">$</div>
</div>

<div id="bottom-tabs" class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
  <div class="mdl-tabs__tab-bar">
    <!--a href="#powers" class="mdl-tabs__tab">Powers</a-->
    <a href="#musicians" class="mdl-tabs__tab is-active">Musicians</a>
    <!--a href="#jokers" class="mdl-tabs__tab">Jokers</a-->
  </div>
  <!--div class="mdl-tabs__panel" id="powers">
    { include_relative power.html }
  </div-->
  <div class="mdl-tabs__panel is-active" id="musicians">
    {% include_relative musicians.html %}
  </div>
  <!-- div class="mdl-tabs__panel" id="jokers">
    lili
  </div-->
</div>

<div id="spinner-background">
  <div id="game-spinner" class="mdl-spinner mdl-js-spinner is-active"></div>
</div>

<dialog class="mdl-dialog" id="modal-option">
  {% include_relative option_menu.html %}
</dialog>

<dialog class="mdl-dialog" id="modal-login">
  {% include_relative login_menu.html %}
</dialog>

<script type="text/javascript" src="/scripts/glMatrix-2.3.2.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.1.0/firebase.js"></script>
<script src="https://code.jquery.com/pep/0.4.1/pep.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyBKKsD6yJWKlApefX-ii-RlQ0ccnz4oSis",
    authDomain: "lirtition.firebaseapp.com",
    databaseURL: "https://lirtition.firebaseio.com",
    storageBucket: "lirtition.appspot.com",
  };
  firebase.initializeApp(config);
</script>

<script id="shader-fs" type="x-shader/x-fragment">
  precision mediump float;

  void main(void) {
    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
  }
</script>

<script id="shader-vs" type="x-shader/x-vertex">
  attribute vec3 aVertexPosition;

  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;

  void main(void) {
    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
  }
</script>

<script type="text/javascript">
  /* ------ Enums ------ */
  var StateEnum = {
    INIT: 0,
    PLAY: 1,
    PAUSE: 2,
  }
  var MusicianEnum = {
    PIANO: 0,
    VIOLIN: 1,
    CELLO: 2,
    TRIANGLE: 3,
    TAMBOUR: 4,
    BASS: 5,
    FRENCH_HORN: 6,
    SIZE: 7,
    properties: {
      0: {name: "piano"},
      1: {name: "violin"},
      2: {name: "cello"},
      3: {name: "triangle"},
      4: {name: "tambour"},
      5: {name: "bass"},
      6: {name: "french_horn"},
    }
  };
  /* ------ Global variables ------ */
  var gl;
  var canvas;
  var g_state = StateEnum.INIT;
  var serverMoney = 0;
  var localMoney = 0;
  var moneyTF;
  var loginDialog;
  var optionDialog;
  var uid = undefined;
  var g_musiciansStats = [];
  var musicians = [];
  var musiciansLvlTF = [];
  var musiciansTF = [];
  var listeners = [];
  var stopSynch = true;
  var lastTime = undefined;
  
  function getHiddenProp(){
      var prefixes = ['webkit','moz','ms','o'];
      // if 'hidden' is natively supported just return it
      if ('hidden' in document) return 'hidden';
      // otherwise loop over all the known prefixes until we find one
      for (var i = 0; i < prefixes.length; i++){
          if ((prefixes[i] + 'Hidden') in document) 
              return prefixes[i] + 'Hidden';
      }
      // otherwise it's not supported
      return null;
  }

  function isHidden() {
      var prop = getHiddenProp();
      if (!prop) return false;
      return document[prop];
  }

  function initWebGL(canvas) {
    var res = null;
    
    try {
      // Try to grab the standard context. If it fails, fallback to experimental.
      res = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
    }
    catch(e) {}
    
    // If we don't have a GL context, give up now
    if (!res) {
      alert("Unable to initialize WebGL. Your browser may not support it.");
      res = null;
    }
    
    return res;
  }

  function setGameState(state) {
    if(g_state == state)
      return;

    console.log("setGameState(" + state + ")");

    switch(state) {
      case StateEnum.PLAY:
        listeners.push(firebase.database().ref('/' + uid + '/game/money').on('value', function(snapshot) {
          console.log("on CB: " + snapshot.val());
          serverMoney = snapshot.val();
          var display = formatNum(serverMoney + localMoney, 2);
          moneyTF.amount.innerHTML = display.val;
          moneyTF.unit.innerHTML = display.unit;
        }));

        listeners.push(firebase.database().ref('/' + uid + '/game/musicians/').on('child_changed'
          , function(snapshot) {
            //console.log("iiii: " + snapshot.params.ID);
            console.log("dddddd:" + snapshot.key);
            console.log("dddddd:" + snapshot.val().lvl);

            musiciansLvlTF[parseInt(snapshot.key)].innerHTML = "Lvl " + snapshot.val().lvl;
        }));
        if(lastTime == undefined)
          lastTime = Date.now();
        stopSynch = false;
        setTimeout(synchMoney, 5000);
        gameLoop();
        g_state = StateEnum.PLAY;
        break;
      case StateEnum.PAUSE:
        // Remove firebase listeners
        firebase.database().ref('/' + uid + '/game/musicians/').off('value', listeners.pop());
        firebase.database().ref('/' + uid + '/game/money').off('value', listeners.pop());
        // Stop synch function
        stopSynch = true;
        g_state = StateEnum.PAUSE;
        break;
      case StateEnum.INIT:
        g_state = StateEnum.INIT;
        break;
    }
  }

  var g_units = ["", "k", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "De", "UnD", "DuD", "TrD", "QaD", "QiD", "SeD", "SpD", "OcD", "NoD", "Vi", "UnV"];
  function floorNum(n) {
    return (Math.abs(n) - Math.abs(Math.floor(n)) >= 0.9999999999999991) ? Math.ceil(n) : Math.floor(n);
  };
  function formatNum(n, d) {
    var l = (floorNum(Math.log(Math.abs(n)) / Math.log(10)) <= 0) ? 0 : floorNum(Math.log(Math.abs(n)) / Math.log(10));
    var p = (l % 3 === 0) ? 2 : (((l - 1) % 3 === 0) ? 1 : 0);
    var r = (Math.abs(n) < 1000) ? ((typeof d === "number") ? n.toFixed(d) : floorNum(n)) : (floorNum(n / (Math.pow(10, floorNum(l / 3) * 3 - p))) / Math.pow(10, p));
    return { val:r, unit:g_units[floorNum(l / 3)].concat("$") };
  };

  function loadGameData() {
    var user = firebase.auth().currentUser;
    uid = user.uid;
    console.log("User uid: " + uid);

    for(var i = 0 ; i < MusicianEnum.SIZE ; i++) {
      musicians[i] = 0;
    }

    var isTimestampLoaded = false;
    var isMoneyLoaded = false;
    var isMusiciansLoaded = false;
    var isGameplayValueLoaded = false;

    function isFinish() {
      if(isGameplayValueLoaded && isMoneyLoaded && isMusiciansLoaded && isTimestampLoaded) {
        loadingScreen(false, false); // Remove loading screen
        // Update musicians upgrade price
        for(var i = 0 ; i < MusicianEnum.SIZE ; i++) {
          var display = formatNum(getMusicianUpgPrice(i, 1), 2);
          musiciansTF[i].cost_amount.innerHTML = display.val;
          musiciansTF[i].cost_unit.innerHTML = display.unit;
        }
        // Start game
        setGameState(StateEnum.PLAY);
      }
    }

    /* ---------------- INITIALISATION LISTENERS --------------------- */
    firebase.database().ref('/gameplay/musicians/').once('value', function(snapshot) {
      isGameplayValueLoaded = true;

      // Store values
      snapshot.forEach(function(childSnapshot) {
        var musId = parseInt(childSnapshot.key);
        g_musiciansStats[musId] = {
          base_cost: parseFloat(childSnapshot.val().base_cost),
          coeff_cost: parseFloat(childSnapshot.val().coeff_cost)
        };
        console.log("tata");
        console.log("stats [" + musId + "] " + g_musiciansStats[musId].base_cost + " " + g_musiciansStats[musId].coeff_cost + " ;");
      });

      isFinish();      
    });

    firebase.database().ref('/' + uid + '/game/lastUpdate/').once('value', function(snapshot) {
      isTimestampLoaded = true;

      if(snapshot.val()) {
        lastTime = snapshot.val();
      }

      isFinish();
    });

    firebase.database().ref('/' + uid + '/game/money/').once('value', function(snapshot) {
      isMoneyLoaded = true;
      if(snapshot.val() > money) {
        serverMoney = snapshot.val();
        var display = formatNum(serverMoney + localMoney, 2);
        moneyTF.amount.innerHTML = display.val; 
        moneyTF.unit.innerHTML = display.unit;
      }

      isFinish();
    });

    firebase.database().ref('/' + uid + '/game/musicians/').once('value', function(snapshot) {
      isMusiciansLoaded = true;
      snapshot.forEach(function(childSnapshot) {
        var instID = parseInt(childSnapshot.key);
        console.log("childSnapshot.key: " + instID);
        musicians[instID] = parseInt(childSnapshot.val().lvl);
        musiciansLvlTF[instID].innerHTML = "Lvl " + musicians[instID];
      });

      isFinish();
    });
  }

  var moneyCounter = 0;
  function gameLoop() {
    if(stopSynch)
      return;

    var now = Date.now();
    var delta = now - lastTime;

    moneyCounter += delta;
    var roundSec = Math.floor(moneyCounter/1000);
    moneyCounter -= 1000*roundSec;
    updateMoney(roundSec);
    
    lastTime = now

    setTimeout(gameLoop, 500);
  }

  var tmpAddedMoney;
  function synchMoney() {
    if(stopSynch)
      return;

    if(localMoney != 0) {
      tmpAddedMoney = localMoney;
      localMoney = 0;
      firebase.database().ref('/' + uid + '/game/').update(
        {
          money: (tmpAddedMoney + serverMoney),
          lastUpdate: lastTime
        });
      /*
      firebase.database().ref('/' + uid + '/game/money').transaction(
        function(currentData){
          console.log("transactionUpdate: " + currentData);
          tmpAddedMoney = localMoney;
          return currentData+tmpAddedMoney;
        },
        function(error, commmited, snapshot) {
          console.log("onComplete(" + commmited + ", " + snapshot.val());
          if(commmited) {
            localMoney -= tmpAddedMoney;
            serverMoney = snapshot.val();
            moneyTF.innerHTML = (serverMoney + localMoney); 
          }
        },
        false);
      */
    }

    setTimeout(synchMoney, 5000);
  }

  function unloadGameData() {
    var isLoaded = false;
    setGameState(StateEnum.PAUSE);
    serverMoney = 0;
    localMoney = 0;
    moneyTF.innerHTML = 0;
    uid = undefined;
    stopSynch = true;
    setGameState(StateEnum.INIT);
  }

  function updateMoney(amount) {
    localMoney+=amount;
    var display = formatNum(serverMoney + localMoney, 2);
    moneyTF.amount.innerHTML = display.val;
    moneyTF.unit.innerHTML = display.unit;
  }

  function getMusicianUpgPrice(musician, nbLvls) {
    console.log("yy" + g_musiciansStats[musician].base_cost);
    if(g_musiciansStats[musician] != null) {
      var s = g_musiciansStats[musician];
      console.log("s.base_cost: " + s.base_cost + " " + typeof s.base_cost);
      console.log("s.base_coeff: " + s.coeff_cost + " " + typeof s.coeff_cost);
      console.log("musicians[musician]: " + musicians[musician] + " " + typeof musicians[musician]);
      return s.base_cost * Math.pow(s.coeff_cost, parseInt(musicians[musician]) + 1);
    } else {
      console.log("unknown musician: " + musician);
      return 150*nbLvls;
    }
  }

  function upgradeMusician(musician) {
    console.log("upgradeMusician [" + musician + "]")
    console.log("name: " + MusicianEnum.properties[musician].name);

    var nbLvls = 1;
    var price = getMusicianUpgPrice(musician, nbLvls);
    console.log("price = " + price);
    if(localMoney + serverMoney > price) {
      updateMoney(-price);
      musicians[musician] += nbLvls;
    }

    firebase.database().ref('/' + uid + '/game/musicians/' + musician + "/").update({
      lvl: musicians[musician]
    });

    musiciansLvlTF[musician].innerHTML = "Lvl " + musicians[musician];
    //Upgrade musician price:
    var display = formatNum(getMusicianUpgPrice(musician, 1), 2);
    musiciansTF[musician].cost_amount.innerHTML = display.val;
    musiciansTF[musician].cost_unit.innerHTML = display.unit;
  }

  function loadingScreen(background, spinner) {
    if(background) {
      document.getElementById("spinner-background").style.display = "flex";
    } else {
      document.getElementById("spinner-background").style.display = "none";
    }

    if(spinner) {
      document.getElementById("game-spinner").className += " is-active";
    } else {
      document.getElementById("game-spinner").className =
        document.getElementById("game-spinner").className.replace(/\bis-active\b/,'');
    }
  }

  function showLoginModal(show) {
    var sub_menu_not_signed = document.getElementById("not-signed");
    var sub_menu_google_signed = document.getElementById("google-signed");
    var sub_menu_anon_signed = document.getElementById("anon-signed");
    var signed_buttons = document.getElementById("signed-buttons");

    if(show) {
      var user = firebase.auth().currentUser;
      if(user != null) {
        // var name = user.displayName;
        // var email = user.email;
        // var photoUrl = user.photoURL;
        // var uid = user.uid;
        console.log("length: " + user.providerData.length);
        var googleEmail = undefined;
        user.providerData.forEach(function (profile) {
          if(profile.providerId == "google.com") {
            googleEmail = profile.email;
          }
        });
        if(googleEmail != undefined) {
          document.getElementById("google-email").innerHTML = googleEmail;
          sub_menu_not_signed.style.display = "none";
          sub_menu_google_signed.style.display = "block";
          sub_menu_anon_signed.style.display = "none";
        } else {
          sub_menu_not_signed.style.display = "none";
          sub_menu_google_signed.style.display = "none";
          sub_menu_anon_signed.style.display = "block";
        }
        signed_buttons.style.display = "block";
      } else {
        // User is null, we ask to sign:
        sub_menu_not_signed.style.display = "block";
        sub_menu_google_signed.style.display = "none";
        sub_menu_anon_signed.style.display = "none";
        signed_buttons.style.display = "none";
      }
      loginDialog.showModal();
    } else {
      loginDialog.close();
    }
  }

  function start() {

    loadingScreen(true, true);

    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // User is signed in.
        console.log("User is signed in");
        loadGameData();
        showLoginModal(false);
      } else {
        // No user is signed in.
        console.log("User is NOT signed in");
        loadingScreen(true, false); // Remove spinner but keep the dark overlay
        showLoginModal(true);
      }
    });

    canvas = document.getElementById("glcanvas");
    canvas.addEventListener( "pointerdown", function( e ) {
      console.log("pointerdown");
      updateMoney(1);
    });
    // Initialize the GL context
    gl = initWebGL(canvas);
    
    // Only continue if WebGL is available and working
    if (gl) {
      // Set clear color to black, fully opaque
      gl.clearColor(0.3, 0.3, 0.3, 1.0);
      // Enable depth testing
      gl.enable(gl.DEPTH_TEST);
      // Near things obscure far things
      gl.depthFunc(gl.LEQUAL);
      // Clear the color as well as the depth buffer.
      gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
    }
  }

  /* ------ START login modal ------ */
  loginDialog = document.querySelector('#modal-login');
  
  loginDialog.querySelector('#button_google').addEventListener('click', function(evt) {
    var provider = new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithRedirect(provider).then(function(result) {
      // This gives you a Google Access Token. You can use it to access the Google API.
      var token = result.credential.accessToken;
      // The signed-in user info.
      var user = result.user;
      // ...
      showLoginModal(false);
    }).catch(function(error) {
      // Handle Errors here.
      var errorCode = error.code;
      var errorMessage = error.message;
      // The email of the user's account used.
      var email = error.email;
      // The firebase.auth.AuthCredential type that was used.
      var credential = error.credential;
      // ...
    });
  });

  loginDialog.querySelector('#button_anon').addEventListener('click', function(evt) {
    firebase.auth().signInAnonymously().then(function(result) {
      showLoginModal(false);
    }).catch(function(error) {
      // Handle Errors here.
      var errorCode = error.code;
      var errorMessage = error.message;
      // ...
    });
  });

  loginDialog.querySelector('.button_close').addEventListener('click', function(evt) {
    showLoginModal(false);
  });

  loginDialog.querySelector('.button_logout').addEventListener('click', function(evt) {
    firebase.auth().signOut().then(function() {
      showLoginModal(false);
      optionDialog.close();
      unloadGameData();
      loadingScreen(true, false);
      showLoginModal(true);
    });
  });

  /* ------ END login modal ------ */

  /* ------ START option menu ------ */
  optionDialog = document.querySelector('#modal-option');
  /*if (! dialog.showModal) {
      dialogPolyfill.registerDialog(dialog);
  }*/
  optionDialog.querySelector('#button_account').addEventListener('click', function(event) {
    showLoginModal(true);
  });
  document.querySelector('#button_option').addEventListener('click', function(event) {
    optionDialog.showModal();
  });
  optionDialog.querySelector('#button_close').addEventListener('click', function(event) {
    optionDialog.close();
  });
  /* ------ END option menu ------ */

  /* ------ START musicians tab ------ */
  for(var i = 0 ; i < MusicianEnum.SIZE ; i++)
  {
    (function(ii) {
      var elt = document.getElementById(MusicianEnum.properties[ii].name);
      musiciansLvlTF[ii] = elt.getElementsByClassName('instrument-lvl')[0];
      elt.getElementsByClassName('upgrade-button')[0].addEventListener('click', function(event) {
        upgradeMusician(ii);
      });
      musiciansTF[ii] = {
        cost_amount: elt.getElementsByClassName('upgrade-amount')[0],
        cost_unit: elt.getElementsByClassName('upgrade-unit')[0]
      }
    })(i);
  }
  /* ------ END musicians tab ------ */

  moneyTF = {
    amount: document.getElementById("money_amount"),
    unit: document.getElementById("money_unit")
  }

  function visChange() {
    if (isHidden()) {
      console.log("Tab Hidden!");
      if(g_state == StateEnum.PLAY) {
        setGameState(StateEnum.PAUSE);
      }
    } else {
       console.log("Tab Visible!");
       if(g_state == StateEnum.PAUSE) {
        setGameState(StateEnum.PLAY);
      }
    }
  }
  var visProp = getHiddenProp();
  if (visProp) {
    var evtname = visProp.replace(/[H|h]idden/,'') + 'visibilitychange';
    document.addEventListener(evtname, visChange);
  }

  window.onload = start;

</script>
