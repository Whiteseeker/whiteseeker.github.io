<div style="float: left;margin-top: 10px;">
    <form id="wmm_parameters" style="float: left;margin: 0 auto;" onsubmit="wmm_startGenerateMap(); return false">
        <div class="formField">Power of 2 <input id="wmm_pot" type="number" name="drop" value="9" placeholder="size will be power of x + 1" required><span id= "error_wmm_pot" class="mdl-badge" data-badge="x" style="display: none;"/></div>
        <div class="mdl-tooltip" for="error_wmm_pot">
            Between 2 and 20
        </div>
        <div class="formField">Seed <input id="wmm_seed" type="text" name="drop" value="Bretagne" required></div>
        <div class="formField">Roughness <input id="wmm_roughness" type="number" step="0.2" min="0" max="100" name="drop" value="2" required></div>
        <div class="formField">Initial altitude <input id="wmm_initalt" type="number" step="0.05" min="0" max="1" name="drop" value="0.2" required></div>
        <div class="formField"><button id="wmm_generateMap" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect">Generate map</button></div>
    </form>
</div>

<script type="text/javascript">

function IsPowerOfTwo(x)
{
    return (x != 0) && ((x & (x - 1)) == 0);
}

function validateForm() {
    var pot = parseInt(document.getElementById("wmm_pot").value);
    console.log("pot = " + pot);

    res = true;

    var elt = document.getElementById("error_wmm_pot");
    if(pot < 0 || pot > 20){
        res = false;
        elt.style.display=null;
    } else {
        elt.style.display="none";
    }   

    var seed = document.getElementById('wmm_seed').value;
    console.log("seed = " + seed);

    var roughness = document.getElementById("wmm_roughness").value;
    console.log("roughness = " + roughness);

    var initalt = document.getElementById("wmm_initalt").value;
    console.log("initalt = " + initalt);

    return res;
}

function wmm_startGenerateMap() {
    console.log("->wmm_startGenerateMap()");

    if(!validateForm())
        return;

    var pot = parseInt(document.getElementById("wmm_pot").value);
    console.log("pot = " + pot);

    var seed = document.getElementById('wmm_seed').value;
    console.log("seed = " + seed);

    var roughness = document.getElementById("wmm_roughness").value;
    console.log("roughness = " + roughness);

    var initalt = document.getElementById("wmm_initalt").value;
    console.log("initalt = " + initalt);

    if(typeof(Worker) !== "undefined") {
        if(typeof(wm) == "undefined") {
            wm = new Worker("map_fractal_3d/wormsThreeDMapGenerator.js");
            wm.postMessage({pot:pot, seed: seed, roughness: roughness, initalt: initalt});
        }
        wm.onmessage = function(event) {
            if(event.data.type == "Result") {
                lastWidth = Math.pow(2, pot) + 1;
                lastHeight = Math.pow(2, pot) + 1;

                wmm_displayMap(event.data.data, Math.pow(2, pot) + 1, Math.pow(2, pot) + 1);

                wm.terminate();
                wm = undefined;

            } else if(event.data.type == "Update") {
                console.log("update : " + event.data.val);
            } else {
                console.log("event type: " + event.type);
            }
        };
    } else {
        console.log("Sorry, your browser does not support Web Workers...");
    }

    console.log("<-wmm_startGenerateMap");
}

function wmm_displayMap(map, w, h) {
    console.log("wmm_displayMap");
    var c = document.getElementById("mapCanvas");
    c.width = w;
    c.height = h;
    var ctx = c.getContext("2d");

    var imgData = ctx.createImageData(w, h);

    for (var i = 0; i < map.length; i++) {
        imgData.data[4*i+0] = map[map.length - i];
        imgData.data[4*i+1] = map[map.length - i];
        imgData.data[4*i+2] = map[map.length - i];
        imgData.data[4*i+3] = 255;
    }

    ctx.putImageData(imgData, 0, 0);
}

</script>