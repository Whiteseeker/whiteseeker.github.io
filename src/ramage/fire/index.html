---
layout: post
title: RaMaGe
category : gamedev
custom_css: ['ramage/map.css']
tags : [gamedev, procedural, beginner]
---
<!DOCTYPE html>
<html>
<body>
  <div style="display: flex; justify-content: space-around;">
    <div name="canal_def">
      <canvas id="r_canva" class="canal_canva" width="128" height="128" style="margin: auto; display: block; padding: 0px 0px 5px 0px;">Your browser does not support the HTML5 canvas tag.</canvas>
      <div class="canal_parameters" style="float: left;margin: 0 auto;">
        <select class="algo_type">
          <option value="fract_3d">Fractal 3D</option>
          <option value="perlin">Perlin</option>
        </select>
        <div class="algo_options">
          <div class="fract_3d_opts">
            Seed<br><input class="seed" type="text" name="drop" value="Breizh"><br>
            Roughness<br><input class="roughness" type="number" step="0.2" min="0" max="100" name="drop" value="2"><br>
            Initial altitude<br><input class="initalt" type="number" step="0.05" min="0" max="1" name="drop" value="0.2"><br>
          </div>
          <div class="perlin_opts">
            Seed<br><input class="seed" type="text" name="drop" value="Breizh"><br>
            Perlin size<br><input class="perlin_size" type="number" step="1" min="2" name="drop" value="64"><br>
          </div>
        </div>
        <div><input id="r_generateMap" class="refresh_button" type="button" value="Refresh"/></div>
      </div>
    </div>
    <div name="canal_def">
      <canvas id="g_canva" class="canal_canva" width="128" height="128" style="margin: auto; display: block; padding: 0px 0px 5px 0px;">Your browser does not support the HTML5 canvas tag.</canvas>
      <div class="canal_parameters" style="float: left;margin: 0 auto;">
        <select class="algo_type">
          <option value="fract_3d">Fractal 3D</option>
          <option value="perlin">Perlin</option>
        </select>
        <div class="algo_options">
          <div class="fract_3d_opts">
            Seed<br><input class="seed" type="text" name="drop" value="Kreiz Breizh"><br>
            Roughness<br><input class="roughness" type="number" step="0.2" min="0" max="100" name="drop" value="2"><br>
            Initial altitude<br><input class="initalt" type="number" step="0.05" min="0" max="1" name="drop" value="0.2"><br>
          </div>
          <div class="perlin_opts">
            Seed<br><input class="seed" type="text" name="drop" value="Kreiz Breizh"><br>
            Perlin size<br><input class="perlin_size" type="number" step="1" min="2" name="drop" value="64"><br>
          </div>
        </div>
        <div><input id="g_generateMap" class="refresh_button" type="button" value="Refresh"/></div>
      </div>
    </div>
    <div name="canal_def">
      <canvas id="b_canva" class="canal_canva" width="128" height="128" style="margin: auto; display: block; padding: 0px 0px 5px 0px;">Your browser does not support the HTML5 canvas tag.</canvas>
      <div class="canal_parameters" style="float: left;margin: 0 auto;">
        <select class="algo_type">
          <option value="fract_3d">Fractal 3D</option>
          <option value="perlin">Perlin</option>
        </select>
        <div class="algo_options">
          <div class="fract_3d_opts">
            Seed<br><input class="seed" type="text" name="drop" value="Donemat"><br>
            Roughness<br><input class="roughness" type="number" step="0.2" min="0" max="100" name="drop" value="2"><br>
            Initial altitude<br><input class="initalt" type="number" step="0.05" min="0" max="1" name="drop" value="0.2"><br>
          </div>
          <div class="perlin_opts">
            Seed<br><input class="seed" type="text" name="drop" value="Donemat"><br>
            Perlin size<br><input class="perlin_size" type="number" step="1" min="2" name="drop" value="64"><br>
          </div>
        </div>
        <div><input id="b_generateMap" class="refresh_button" type="button" value="Refresh"/></div>
      </div>
    </div>
    <div name="canal_def">
      <canvas id="a_canva" class="canal_canva" width="128" height="128" style="margin: auto; display: block; padding: 0px 0px 5px 0px;">Your browser does not support the HTML5 canvas tag.</canvas>
      <div class="canal_parameters" style="float: left;margin: 0 auto;">
        <select class="algo_type">
          <option value="fract_3d">Fractal 3D</option>
          <option value="perlin">Perlin</option>
        </select>
        <div class="algo_options">
          <div class="fract_3d_opts">
            Seed<br><input class="seed" type="text" name="drop" value="Degemer"><br>
            Roughness<br><input class="roughness" type="number" step="0.2" min="0" max="100" name="drop" value="2"><br>
            Initial altitude<br><input class="initalt" type="number" step="0.05" min="0" max="1" name="drop" value="0.2"><br>
          </div>
          <div class="perlin_opts">
            Seed<br><input class="seed" type="text" name="drop" value="Degemer"><br>
            Perlin size<br><input class="perlin_size" type="number" step="1" min="2" name="drop" value="64"><br>
          </div>
        </div>
        <div><input id="a_generateMap" class="refresh_button" type="button" value="Refresh"/></div>
      </div>
    </div>
  </div>
  <div>
    <canvas id="final_canva" width="512" height="512" style="margin: auto; display: block; padding: 0px 0px 5px 0px;">Your browser does not support the HTML5 canvas tag.</canvas>
    <div id="final_parameters" style="float: left;margin: 0 auto;">
    </div>
  </div>
  <div>
    <canvas id="render_canva" width="512" height="512" style="margin: auto; display: block; padding: 0px 0px 5px 0px;">Your browser does not support the HTML5 canvas tag.</canvas>
    <div id="render_parameters" style="float: left;margin: 0 auto;">
      Fire speed <input class="firespeed" type="number" step="0.2" min="0" max="100" value="0.4"><br>
      <div><input id="render_generateMap" type="button" value="Refresh"/></div>
    </div>
  </div>


  <script type="text/javascript" src="/scripts/gl-matrix-2.4.0.min.js"></script>
  <script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;

    varying vec2 vTextureCoord;

    uniform sampler2D uSampler;
    uniform float time;

    void main(void) {
      vec2 uv = vTextureCoord;

      // Generate noisy x value
      vec2 n0Uv = vec2(uv.x*1.4 + 0.01, uv.y + time*0.69);
      vec2 n1Uv = vec2(uv.x*0.5 - 0.033, uv.y*2.0 + time*0.12);
      vec2 n2Uv = vec2(uv.x*0.94 + 0.02, uv.y*3.0 + time*0.61);
      float n0 = (texture2D(uSampler, n0Uv).w-0.5)*2.0;
      float n1 = (texture2D(uSampler, n1Uv).w-0.5)*2.0;
      float n2 = (texture2D(uSampler, n2Uv).w-0.5)*2.0;
      float noiseA = clamp(n0 + n1 + n2, -1.0, 1.0);

      // Generate noisy y value
      vec2 n0UvB = vec2(uv.x*0.7 - 0.01, uv.y + time*0.27);
      vec2 n1UvB = vec2(uv.x*0.45 + 0.033, uv.y*1.9 + time*0.61);
      vec2 n2UvB = vec2(uv.x*0.8 - 0.02, uv.y*2.5 + time*0.51);
      float n0B = (texture2D(uSampler, n0UvB).w-0.5)*2.0;
      float n1B = (texture2D(uSampler, n1UvB).w-0.5)*2.0;
      float n2B = (texture2D(uSampler, n2UvB).w-0.5)*2.0;
      float noiseB = clamp(n0B + n1B + n2B, -1.0, 1.0);

      vec2 finalNoise = vec2(noiseA, noiseB);
      float perturb = (1.0 - uv.y) * 0.35 + 0.02;
      finalNoise = (finalNoise * perturb) + uv - 0.02;

      vec4 color = texture2D(uSampler, finalNoise);
      color = vec4(color.x*2.0, color.y*0.9, (color.y/color.x)*0.2, 1.0);
      finalNoise = clamp(finalNoise, 0.05, 1.0);
      color.w = texture2D(uSampler, finalNoise).z*2.0;
      color.w = color.w*texture2D(uSampler, uv).z;
      gl_FragColor = color;

      //gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
      //gl_FragColor = vec4(vTextureCoord.s, vTextureCoord.t, 1.0, 1.0);;
    }
  </script>

  <script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    varying vec2 vTextureCoord;

    uniform mat4 MVP;

    void main(void) {
      gl_Position = MVP * vec4(aVertexPosition, 1.0);
      vTextureCoord = aTextureCoord;
    }
  </script>

  <script type="text/javascript">

  class Renderer  {
    constructor() {
      this.canva = document.getElementById("render_canva");

      try {
        this.gl = this.canva.getContext("webgl2");
        this.gl.viewportWidth = this.canva.width;
        this.gl.viewportHeight = this.canva.height;
      } catch(e) {
        alert("WebGL error!");
      }
    }

    init() {
      var gl = this.gl;
      this.initShaders();
      this.initBuffers();

      var imgData = new ImageData(512, 512);
      for (var x = 0; x < 512; x++) {
        for (var y = 0; y < 512; y++) {
          for (var chan = 0 ; chan < 4 ; chan++) {
            if (chan != 3) {
              imgData.data[4*(x + y*512)+chan] = 10;
            } else {
              imgData.data[4*(x + y*512)+chan] = 255;
            }
          }
        }
      }
      this.updateTexture(imgData);

      // Projection matrix
      this.P = mat4.create();
      mat4.perspective(this.P, glMatrix.toRadian(45.0), 1.0, 0.1, 100.0);
      // View matrix
      this.V = mat4.create();
      mat4.lookAt(this.V,
                [2,1,3], // Camera is at (4,3,3), in World Space
                [0,0,0], // and looks at the origin
                [0,1,0]);  // Head is up (set to 0,-1,0 to look upside-down));
      this.MVP = mat4.create();
      mat4.multiply(this.MVP, this.P, this.V);

      gl.clearColor(0.05, 0.05, 0.3, 1.0);
      gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);

      gl.enable(gl.BLEND);
      gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
    }

    initShaders() {
      var gl = this.gl;
      var fragmentShader = this.getShader("shader-fs");
      var vertexShader = this.getShader("shader-vs");

      this.shaderProgram = gl.createProgram();
      gl.attachShader(this.shaderProgram, vertexShader);
      gl.attachShader(this.shaderProgram, fragmentShader);
      gl.linkProgram(this.shaderProgram);

      this.shaderProgram.vertexPositionAttribute = gl.getAttribLocation(this.shaderProgram, "aVertexPosition");
      this.shaderProgram.textureCoordAttribute = gl.getAttribLocation(this.shaderProgram, "aTextureCoord");
      this.shaderProgram.uniformMVP = gl.getUniformLocation(this.shaderProgram, "MVP");
      this.shaderProgram.samplerUniform = gl.getUniformLocation(this.shaderProgram, "uSampler");

      if (!this.gl.getProgramParameter(this.shaderProgram, this.gl.LINK_STATUS)) {
        alert("Shader error !");
      }

      this.gl.useProgram(this.shaderProgram);
    }

    getShader(id) {
      var shaderScript = document.getElementById(id);
      if (!shaderScript) {
          return null;
      }

      var str = "";
      var k = shaderScript.firstChild;
      while (k) {
        if (k.nodeType == 3)
          str += k.textContent;
        k = k.nextSibling;
      }

      var shader;
      if (shaderScript.type == "x-shader/x-fragment") {
        shader = this.gl.createShader(this.gl.FRAGMENT_SHADER);
      } else if (shaderScript.type == "x-shader/x-vertex") {
        shader = this.gl.createShader(this.gl.VERTEX_SHADER);
      } else {
        return null;
      }

      this.gl.shaderSource(shader, str);
      this.gl.compileShader(shader);

      if (!this.gl.getShaderParameter(shader, this.gl.COMPILE_STATUS)) {
        alert(this.gl.getShaderInfoLog(shader));
        return null;
      }

      return shader;
    }

    initBuffers() {
      var gl = this.gl;
      this.squareVertexPositionBuffer = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, this.squareVertexPositionBuffer);
      var vertices = [
           1.0,  1.0,  0.0,
          -1.0,  1.0,  0.0,
           1.0, -1.0,  0.0,
          -1.0, -1.0,  0.0
      ];
      gl.bufferData(this.gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
      this.squareVertexPositionBuffer.itemSize = 3;
      this.squareVertexPositionBuffer.numItems = 4;

      this.squareVertexTextureCoordBuffer = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, this.squareVertexTextureCoordBuffer);
      var textureCoords = [
        1, 1,
        0, 1,
        1, 0,
        0, 0
      ];
      gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(textureCoords), gl.STATIC_DRAW);
      this.squareVertexTextureCoordBuffer.itemSize = 2;
      this.squareVertexTextureCoordBuffer.numItems = 4;
    }

    updateTexture(imgdata) {
      console.log("Renderer.updateTexture");
      var gl = this.gl;

      if(this.tex)
        gl.deleteTexture(this.tex);
      this.tex =  gl.createTexture();

      gl.bindTexture(gl.TEXTURE_2D, this.tex);
      gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
      gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 512, 512, 0, gl.RGBA, gl.UNSIGNED_BYTE, imgdata);
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
      gl.bindTexture(gl.TEXTURE_2D, null);

    }

    draw() {
      var gl = this.gl;
      console.log("Renderer.draw");
      gl.clear(gl.COLOR_BUFFER_BIT);

      gl.uniformMatrix4fv(this.shaderProgram.uniformMVP, false, this.MVP);

      gl.enableVertexAttribArray(this.shaderProgram.vertexPositionAttribute);
      gl.bindBuffer(gl.ARRAY_BUFFER, this.squareVertexPositionBuffer);
      gl.vertexAttribPointer(this.shaderProgram.vertexPositionAttribute, this.squareVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

      gl.enableVertexAttribArray(this.shaderProgram.textureCoordAttribute);
      gl.bindBuffer(gl.ARRAY_BUFFER, this.squareVertexTextureCoordBuffer);
      gl.vertexAttribPointer(this.shaderProgram.textureCoordAttribute, this.squareVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

      gl.activeTexture(gl.TEXTURE0);
      gl.bindTexture(gl.TEXTURE_2D, this.tex);
      gl.uniform1i(this.shaderProgram.samplerUniform, 0);


      gl.drawArrays(gl.TRIANGLE_STRIP, 0, this.squareVertexPositionBuffer.numItems);
    }
  }

  var data_channel = [];
  var canalDefElts = document.getElementsByName("canal_def");
  var renderer = new Renderer();

  renderer.init();

  for (var elt = 0 ; elt < canalDefElts.length ; elt++) {
    var refreshButton = canalDefElts[elt].querySelector(".refresh_button");
    console.log("refresh button id: " + refreshButton.id);
    
    refreshButton.onclick = (function(c_def, channel_id) { 
      return function() {
        refreshCanal(c_def, channel_id);
      };
    })(canalDefElts[elt], elt);

    var algo_list = canalDefElts[elt].querySelector(".canal_parameters .algo_type");
    algo_list.addEventListener("change", (function(c_def) {
      return function() {
        updateOptionDisplay(c_def);
      };
    })(canalDefElts[elt]));
    updateOptionDisplay(canalDefElts[elt]);
  }

  function updateOptionDisplay(canalDef) {
    var algo_list = canalDef.querySelector(".canal_parameters .algo_type");
    var opts = [];
    opts[0] = canalDef.querySelector(".fract_3d_opts");
    opts[1] = canalDef.querySelector(".perlin_opts");

    for (var i = 0 ; i < opts.length ; i++) {
      if (i == algo_list.selectedIndex) {
        // Display the options
        opts[i].style.display = 'block';
      } else {
        // hide the options
        opts[i].style.display = 'none';
      }
    }
    /*switch(algo_list.selectedIndex) {
      case 0:
        // Fractal 3d
        break;
      case 1:
        // Perlin noise

        break;
    }*/
  }

  function refreshCanal(canalDef, channel_id) {
    var canva = canalDef.querySelector(".canal_canva");
    console.log("canva id: " + canva.id);
    var algo_list = canalDef.querySelector(".canal_parameters .algo_type");
    console.log("algo: " + algo_list.options[algo_list.selectedIndex].value);

    var final_canva = document.getElementById("final_canva");
    var width = final_canva.width;
    var height = final_canva.height;

    var worker_path;
    var params;
    switch(algo_list.selectedIndex) {
      case 0:
        worker_path = "../map_fractal_3d/wormsThreeDMapGenerator.js";

        // Get the options
        var opts = canalDef.querySelector(".fract_3d_opts");
        var roughness = opts.querySelector(".roughness").value;
        var initalt = opts.querySelector(".initalt").value;
        var seed = opts.querySelector(".seed").value;

        params = {pot:9, seed: seed, roughness: roughness, initalt: initalt, tileable: true};
        break;
      case 1:
        worker_path = "../classic_perlin/perlinNoiseGenerator.js";

        // Get the options
        var opts = canalDef.querySelector(".perlin_opts");
        var perlin_size = opts.querySelector(".perlin_size").value;
        var seed = opts.querySelector(".seed").value;

        params = {width:width, height:height, seed: seed, perlin_size: perlin_size};
        break;
    }
    console.log("Worker path: " + worker_path);

    if(typeof(Worker) !== "undefined") {
      if(typeof(w) == "undefined") {
        w = new Worker(worker_path);
        w.postMessage(params);
      } else {
        console.log("Seems like a worker is already working ... can't invoke another one !");
      }
      w.onmessage = function(event) {
        if(event.data.type == "Result") {
          data_channel[channel_id] = event.data.data;
          update_Thumbmail(event.data.data, event.data.width, event.data.height, canva);
          w.terminate();
          w = undefined;
        } else if(event.data.type == "Update") {
          console.log("update : " + event.data.val);
        } else {
          console.log("event type: " + event.type);
        }
      };
    } else {
        console.log("Sorry, your browser does not support Web Workers...");
    }
  }

  function update_Thumbmail(data, data_width, data_height, canva) {
    console.log("data_width: " + data_width);
    console.log("data_height: " + data_height);
    console.log("canva.width: " + canva.width);
    console.log("canva.height: " + canva.height);
    var ctx = canva.getContext("2d");
    var imgData = ctx.createImageData(canva.width, canva.height);

    var scale_ratio_w = data_width / canva.width;
    var scale_ratio_h = data_height / canva.height;

    for (var x = 0; x < canva.width; x++) {
      for (var y = 0; y < canva.height; y++) {
        var resized_x = Math.floor(x*scale_ratio_w);
        var resized_y = Math.floor(y*scale_ratio_h);
        var pix = data[data.length - (resized_x + resized_y*data_width)];
        imgData.data[4*(x + y*canva.width)+0] = pix;
        imgData.data[4*(x + y*canva.width)+1] = pix;
        imgData.data[4*(x + y*canva.width)+2] = pix;
        imgData.data[4*(x + y*canva.width)+3] = 255;
      }
    }

    ctx.putImageData(imgData, 0, 0);
    updateFinalTexture();
  }

  function updateFinalTexture() {
    var canva = document.getElementById("final_canva");

    var ctx = canva.getContext("2d");
    var imgData = ctx.createImageData(canva.width, canva.height);

    for (var x = 0; x < canva.width; x++) {
      for (var y = 0; y < canva.height; y++) {
        for (var chan = 0 ; chan < 4 ; chan++) {
          if (data_channel[chan]) {
            imgData.data[4*(x + y*canva.width)+chan] = data_channel[chan][data_channel[chan].length - (x + y*canva.width)];
          } else {
            imgData.data[4*(x + y*canva.width)+chan] = 255;
          }
        }
      }
    }

    ctx.putImageData(imgData, 0, 0);
    renderer.updateTexture(imgData);
    renderer.draw();
  }

  </script>
</body>
</html>