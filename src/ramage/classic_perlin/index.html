<div style="float: left;margin-top: 10px;">
    <form id="perlin_parameters" style="float: left;margin: 0 auto;" onsubmit="classic_startGenerateMap(); return false">
        <div class="formField">Width <input id="perlin_width" type="number" name="drop" value="257" placeholder="(power of 2) + 1" required><span id= "error_perlin_width" class="mdl-badge" data-badge="x" style="display: none;"/></div>
        <div class="mdl-tooltip" for="error_perlin_width">
            Must be a power of 2 + 1
        </div>
        <div class="formField">Height <input id="perlin_height" type="number" name="drop" value="257" placeholder="(power of 2) + 1" required><span id= "error_perlin_height"class="mdl-badge" data-badge="x" style="display: none;"/></div>
        <div class="mdl-tooltip" for="error_perlin_height">
            Must be a power of 2 + 1
        </div>
        <div class="formField">Seed <input id="perlin_seed" type="text" name="drop" value="Bretagne" required></div>
        <div class="formField">Perlin size <input id="perlin_size" type="number" step="1" min="2" name="drop" value="64" required><span id= "error_perlin_size" class="mdl-badge" data-badge="x" style="display: none;"/></div>
        <div class="mdl-tooltip" for="error_perlin_size">
            Must be a power of 2
        </div>
        <div class="formField"><button id="perlin_generateMap" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect">Generate map</button></div>
    </form>
</div>

<script type="text/javascript">

function IsPowerOfTwo(x)
{
    return (x != 0) && ((x & (x - 1)) == 0);
}

function validateForm() {
    var width = parseInt(document.getElementById("perlin_width").value);
    console.log("width = " + width);

    res = true;

    var elt = document.getElementById("error_perlin_width");
    /*if(!IsPowerOfTwo(width-1)){
        res = false;
        elt.style.display=null;
    } else {*/
        elt.style.display="none";
    //}

    var height = parseInt(document.getElementById("perlin_height").value);
    console.log("height = " + height);
    
    elt = document.getElementById("error_perlin_height");
    /*if(!IsPowerOfTwo(height-1)){
        elt.style.display=null;
        res = false;
    } else {*/
        elt.style.display="none";
    //}
        

    var seed = document.getElementById('perlin_seed').value;
    console.log("seed = " + seed);

    elt = document.getElementById("error_perlin_size");
    var perlin_size = document.getElementById("perlin_size").value;
    console.log("perlin size = " + perlin_size);
    if(!IsPowerOfTwo(perlin_size)){
        elt.style.display=null;
        res = false;
    } else {
        elt.style.display="none";
    }

    return res;
}

function classic_startGenerateMap() {
    console.log("->classic_startGenerateMap()");

    if(!validateForm())
        return;

    var width = parseInt(document.getElementById("perlin_width").value);
    console.log("width = " + width);

    var height = parseInt(document.getElementById("perlin_height").value);
    console.log("height = " + height);

    var seed = document.getElementById('perlin_seed').value;
    console.log("seed = " + seed);

    var perlin_size = document.getElementById("perlin_size").value;
    console.log("perlin size = " + perlin_size);

    if(typeof(Worker) !== "undefined") {
        if(typeof(wm) == "undefined") {
            wm = new Worker("classic_perlin/perlinNoiseGenerator.js");
            wm.postMessage({width:width, height:height, seed: seed, perlin_size: perlin_size});
        }
        wm.onmessage = function(event) {
            if(event.data.type == "Result") {
                lastWidth = width;
                lastHeight = height;

                perlin_displayMap(event.data.data, width, height);

                wm.terminate();
                wm = undefined;

            } else if(event.data.type == "Update") {
                console.log("update : " + event.data.val);
            } else {
                console.log("event type: " + event.type);
            }
        };
    } else {
        console.log("Sorry, your browser does not support Web Workers...");
    }

    console.log("<-classic_startGenerateMap");
}

function perlin_displayMap(map, w, h) {
    console.log("perlin_displayMap");
    var c = document.getElementById("mapCanvas");
    c.width = w;
    c.height = h;
    var ctx = c.getContext("2d");

    var imgData = ctx.createImageData(w, h);

    for (var i = 0; i < map.length; i++) {
        imgData.data[4*i+0] = map[map.length - i];
        imgData.data[4*i+1] = map[map.length - i];
        imgData.data[4*i+2] = map[map.length - i];
        imgData.data[4*i+3] = 255;
    }

    ctx.putImageData(imgData, 0, 0);
}

</script>