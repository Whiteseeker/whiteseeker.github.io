<!DOCTYPE html>
<html lang="en">

  {% include head.html %}

  <body class="mdl-demo mdl-color--grey-100 mdl-color-text--grey-700 mdl-base">

    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
      {% include header.html %}

      <main class="mdl-layout__content">
        
        {{ content }}

        {% include footer.html %}
      </main>
      </div>


    <script type="text/javascript">
      function downloadJSAtOnload() {
        var element = document.createElement("script");
        element.src = "/css/photoswipe/photoswipe.min.js";
        document.body.appendChild(element);
        element = document.createElement("script");
        element.src = "/css/photoswipe/photoswipe-ui-default.min.js";
        document.body.appendChild(element);
      }
      if (window.addEventListener)
        window.addEventListener("load", downloadJSAtOnload, false);
      else if (window.attachEvent)
        window.attachEvent("onload", downloadJSAtOnload);
      else
        window.onload = downloadJSAtOnload;

      var myDataRef = new Firebase('https://luminous-inferno-9971.firebaseio.com/');
      var isPushEnabled = false;
      function initialiseState() {
        console.log('initialiseState');  
        // Are Notifications supported in the service worker?  
        if (!('showNotification' in ServiceWorkerRegistration.prototype)) {  
          console.warn('Notifications aren\'t supported.');  
          return;  
        }

        // Check the current Notification permission.  
        // If its denied, it's a permanent block until the  
        // user changes the permission  
        if (Notification.permission === 'denied') {
          console.warn('The user has blocked notifications.');
          return;
        }

        // Check if push messaging is supported  
        if (!('PushManager' in window)) {
          console.warn('Push messaging isn\'t supported.');
          return;
        }

        console.log("check for a subscription ");
        // We need the service worker registration to check for a subscription  
        navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) {
          console.log("service worker is ready");
          // Do we already have a push message subscription?
          serviceWorkerRegistration.pushManager.getSubscription()
            .then(function(subscription) {
              console.log("enable ui");
              // Enable any UI which subscribes / unsubscribes from
              // push messages.
              var pushButton = document.querySelector('#switch-notif');
              pushButton.disabled = false;

              if (!subscription) {
                // We aren't subscribed to push, so set UI  
                // to allow the user to enable push
                console.log("enable ui");
                pushButton.checked = false;
                return;  
              }

              pushButton.checked = true;

              // Keep your server in sync with the latest subscriptionId
              sendSubscriptionToServer(subscription);

              // Set your UI to show they have subscribed for
              // push messages
              //pushButton.textContent = 'Disable Push Messages';
              isPushEnabled = true;
            })  
            .catch(function(err) {
              console.warn('Error during getSubscription()', err);
            });
        });  
      }

      function sendSubscriptionToServer(subscription) {
        console.log("sendSubscriptionToServer(" + subscription.endpoint + ")");
        myDataRef.set('chromePN:'+subscription.endpoint);
      }

      function subscribe() {  
        // Disable the button so it can't be changed while  
        // we process the permission request  
        var pushButton = document.querySelector('#switch-notif');  
        pushButton.disabled = true;

        navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) {  
          serviceWorkerRegistration.pushManager.subscribe({userVisibleOnly: true})  
            .then(function(subscription) {  
              // The subscription was successful  
              isPushEnabled = true;  
              pushButton.textContent = 'Disable Push Messages';  
              pushButton.disabled = false;

              // TODO: Send the subscription.endpoint to your server  
              // and save it to send a push message at a later date
              return sendSubscriptionToServer(subscription);  
            })  
            .catch(function(e) {  
              if (Notification.permission === 'denied') {  
                // The user denied the notification permission which  
                // means we failed to subscribe and the user will need  
                // to manually change the notification permission to  
                // subscribe to push messages  
                console.warn('Permission for Notifications was denied');  
                pushButton.disabled = true;  
              } else {  
                // A problem occurred with the subscription; common reasons  
                // include network errors, and lacking gcm_sender_id and/or  
                // gcm_user_visible_only in the manifest.  
                console.error('Unable to subscribe to push.', e);  
                pushButton.disabled = false;  
                pushButton.textContent = 'Enable Push Messages';  
              }  
            });  
        });  
      }

      window.addEventListener('load', function() {
        var pushButton = document.getElementById('switch-notif');
        pushButton.addEventListener('click', function() {
          if (isPushEnabled) {
            console.log("unsubscribe()");
          } else {
            console.log("subscribe()");
            subscribe();
          }
        });

        // Check that service workers are supported, if so, progressively  
        // enhance and add push messaging support, otherwise continue without it.  
        if ('serviceWorker' in navigator) {
          console.log("serviceWorker in navigator");
          navigator.serviceWorker.register('/service-worker.js')
          .then(initialiseState);
        } else {
          console.warn('Service workers aren\'t supported in this browser.');
        }
      });
    </script>

    <script asynch src="/scripts/material.min.js"></script>
    <link rel="stylesheet" href="/css/merged.min.css">
  </body>

</html>
