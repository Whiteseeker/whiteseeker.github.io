<!DOCTYPE html>
<html lang="en">

  {% include head.html %}

  <body class="mdl-demo mdl-color--grey-100 mdl-color-text--grey-700 mdl-base">

    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
      {% include header.html %}

      <main class="mdl-layout__content">
        
        {{ content }}

        {% include footer.html %}
      </main>
      </div>


    <script type="text/javascript">
      function downloadJSAtOnload() {
        var element = document.createElement("script");
        element.src = "/css/photoswipe/photoswipe.min.js";
        document.body.appendChild(element);
        element = document.createElement("script");
        element.src = "/css/photoswipe/photoswipe-ui-default.min.js";
        document.body.appendChild(element);
      }
      if (window.addEventListener)
        window.addEventListener("load", downloadJSAtOnload, false);
      else if (window.attachEvent)
        window.attachEvent("onload", downloadJSAtOnload);
      else
        window.onload = downloadJSAtOnload;

      var isPushEnabled = false;
      function initialiseState() {
        console.log('initialiseState');  
        // Are Notifications supported in the service worker?  
        if (!('showNotification' in ServiceWorkerRegistration.prototype)) {  
          console.warn('Notifications aren\'t supported.');  
          return;  
        }

        // Check the current Notification permission.  
        // If its denied, it's a permanent block until the  
        // user changes the permission  
        if (Notification.permission === 'denied') {
          console.warn('The user has blocked notifications.');
          return;
        }

        // Check if push messaging is supported  
        if (!('PushManager' in window)) {
          console.warn('Push messaging isn\'t supported.');
          return;
        }

        console.log("check for a subscription ");
        // We need the service worker registration to check for a subscription  
        navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) {
          console.log("service worker is ready");
          // Do we already have a push message subscription?
          serviceWorkerRegistration.pushManager.getSubscription()
            .then(function(subscription) {
              console.log("enable ui");
              // Enable any UI which subscribes / unsubscribes from
              // push messages.
              var pushButton = document.querySelector('#switch-notif');
              //pushButton.disabled = false;
              pushButton.MaterialCheckbox.enable();

              if (!subscription) {
                // We aren't subscribed to push, so set UI  
                // to allow the user to enable push
                console.log("enable ui");
                //pushButton.checked = false;
                pushButton.MaterialCheckbox.uncheck();
                return;  
              }

              pushButton.MaterialCheckbox.check();
              //pushButton.checked = true;

              // Keep your server in sync with the latest subscriptionId
              sendSubscriptionToServer(subscription);

              // Set your UI to show they have subscribed for
              // push messages
              //pushButton.textContent = 'Disable Push Messages';
              isPushEnabled = true;
            })  
            .catch(function(err) {
              console.warn('Error during getSubscription()', err);
            });
        });  
      }

      String.prototype.hashCode = function() {
        var hash = 0, i, chr, len;
        if (this.length === 0) return hash;
        for (i = 0, len = this.length; i < len; i++) {
          chr   = this.charCodeAt(i);
          hash  = ((hash << 5) - hash) + chr;
          hash |= 0; // Convert to 32bit integer
        }
        return hash;
      };

      function sendSubscriptionToServer(subscription) {
        if(subscription.endpoint.startsWith("https://android.googleapis.com/gcm/send/")) {
          var pntoken = subscription.endpoint.substring("https://android.googleapis.com/gcm/send/".length);
          console.log("push token: " + pntoken);
          var wilmaRef = new Firebase('https://luminous-inferno-9971.firebaseio.com/pntokens/'+pntoken.hashCode());
          wilmaRef.transaction(function(currentData) {
            if (currentData === null) {
              return {platform: "chrome", topic: "games", token: pntoken};
            } else {
              console.log('Pn toto already exists.');
              return; // Abort the transaction.
            }
          }, function(error, committed, snapshot) {
            if (error)
              console.log('Transaction failed abnormally!', error);
            else if (!committed)
              console.log('We aborted the transaction (because wilma already exists).');
            else
              console.log('Pn toto added!');
            console.log('Toto\'s data: ', snapshot.val());
          });
        }
      }

      function subscribe() {  
        // Disable the button so it can't be changed while  
        // we process the permission request  
        var pushButton = document.querySelector('#switch-notif');  
        //pushButton.disabled = true;
        pushButton.MaterialCheckbox.disable();

        navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) {  
          serviceWorkerRegistration.pushManager.subscribe({userVisibleOnly: true})  
            .then(function(subscription) {  
              // The subscription was successful  
              isPushEnabled = true;  
              //pushButton.textContent = 'Disable Push Messages';  
              //pushButton.disabled = false;
              pushButton.MaterialCheckbox.enable();
              pushButton.MaterialCheckbox.check();

              // TODO: Send the subscription.endpoint to your server  
              // and save it to send a push message at a later date
              return sendSubscriptionToServer(subscription);  
            })  
            .catch(function(e) {  
              if (Notification.permission === 'denied') {  
                // The user denied the notification permission which  
                // means we failed to subscribe and the user will need  
                // to manually change the notification permission to  
                // subscribe to push messages  
                console.warn('Permission for Notifications was denied');  
                //pushButton.disabled = true;
                pushButton.MaterialCheckbox.disable();
              } else {  
                // A problem occurred with the subscription; common reasons  
                // include network errors, and lacking gcm_sender_id and/or  
                // gcm_user_visible_only in the manifest.  
                console.error('Unable to subscribe to push.', e);  
                //pushButton.disabled = false;
                pushButton.MaterialCheckbox.enable();
              pushButton.MaterialCheckbox.uncheck();
                //pushButton.textContent = 'Enable Push Messages';  
              }  
            });  
        });  
      }

      function unsubscribe() {  
        var pushButton = document.querySelector('#switch-notif');
        //pushButton.disabled = true;
        pushButton.MaterialCheckbox.disable();

        navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) {
          // To unsubscribe from push messaging, you need get the
          // subscription object, which you can call unsubscribe() on.
          serviceWorkerRegistration.pushManager.getSubscription().then(
            function(pushSubscription) {
              // Check we have a subscription to unsubscribe
              if (!pushSubscription) {
                // No subscription object, so set the state
                // to allow the user to subscribe to push
                isPushEnabled = false;
                //pushButton.disabled = false;
                pushButton.MaterialCheckbox.enable();
                pushButton.MaterialCheckbox.uncheck();
                //pushButton.textContent = 'Enable Push Messages';
                return;
              }

              var endpoint = pushSubscription.endpoint;
              // TODO: Make a request to your server to remove
              // the subscriptionId from your data store so you
              // don't attempt to send them push messages anymore
              var pntoken = endpoint.substring("https://android.googleapis.com/gcm/send/".length);
              console.log("push token: " + pntoken);
              var onComplete = function(error) {
                if (error) {
                  console.log('Synchronization failed');
                } else {
                  console.log('Synchronization succeeded');
                }
              };
              var dataRef = new Firebase('https://luminous-inferno-9971.firebaseio.com/pntokens/'+pntoken.hashCode());
              dataRef.remove(onComplete);

              // We have a subscription, so call unsubscribe on it
              pushSubscription.unsubscribe().then(function(successful) {
                //pushButton.disabled = false;
                pushButton.MaterialCheckbox.enable();
                pushButton.MaterialCheckbox.uncheck();
                //pushButton.textContent = 'Enable Push Messages';
                isPushEnabled = false;
              }).catch(function(e) {
                // We failed to unsubscribe, this can lead to
                // an unusual state, so may be best to remove
                // the users data from your data store and
                // inform the user that you have done so

                console.log('Unsubscription error: ', e);
                //pushButton.disabled = false;
                pushButton.MaterialCheckbox.enable();
                //pushButton.textContent = 'Enable Push Messages';
              });
            }).catch(function(e) {  
              console.error('Error thrown while unsubscribing from push messaging.', e);  
            });  
        });  
      }

      window.addEventListener('load', function() {
        var pushButton = document.getElementById('switch-notif');
        pushButton.addEventListener('click', function() {
          if (isPushEnabled) {
            console.log("unsubscribe()");
            unsubscribe();
          } else {
            console.log("subscribe()");
            subscribe();
          }
        });

        // Check that service workers are supported, if so, progressively  
        // enhance and add push messaging support, otherwise continue without it.  
        if ('serviceWorker' in navigator) {
          console.log("serviceWorker in navigator");
          navigator.serviceWorker.register('/service-worker.js')
          .then(initialiseState);
        } else {
          console.warn('Service workers aren\'t supported in this browser.');
        }
      });
    </script>

    <script src="/scripts/material.min.js"></script>
    <link rel="stylesheet" href="/css/merged.min.css">
  </body>

</html>
